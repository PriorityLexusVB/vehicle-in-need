<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Signing In...</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        background: #f8fafc;
        color: #334155;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #e2e8f0;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .message {
        font-size: 16px;
        margin-top: 8px;
      }
      .error {
        color: #dc2626;
        background: #fef2f2;
        border: 1px solid #fecaca;
        padding: 12px 16px;
        border-radius: 8px;
        max-width: 300px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="spinner" id="spinner"></div>
    <div class="message" id="message">Completing sign-in...</div>

    <script>
      /**
       * Auth Popup Callback Handler
       * 
       * This page is loaded in the popup after Firebase/Google OAuth completes.
       * It extracts the auth result and posts a message back to the opener window.
       * 
       * Communication uses postMessage with strict origin validation,
       * avoiding window.closed polling which is blocked by COOP.
       */
      (function() {
        'use strict';

        var spinner = document.getElementById('spinner');
        var messageEl = document.getElementById('message');

        /**
         * Shows an error message in the UI
         */
        function showError(errorMessage) {
          spinner.style.display = 'none';
          messageEl.className = 'message error';
          messageEl.textContent = errorMessage;
        }

        /**
         * Gets the target origin for postMessage
         * This should be the origin of our main app
         */
        function getTargetOrigin() {
          // Try to get origin from URL parameters (set by opener)
          var urlParams = new URLSearchParams(window.location.search);
          var openerOrigin = urlParams.get('origin');
          
          if (openerOrigin) {
            return openerOrigin;
          }

          // Fall back to inferring from referrer or document
          if (document.referrer) {
            try {
              return new URL(document.referrer).origin;
            } catch (e) {
              // Invalid referrer URL
            }
          }

          // Last resort: if window.opener exists, try to get its origin
          // (may fail due to COOP, that's okay)
          try {
            if (window.opener && window.opener.location && window.opener.location.origin) {
              return window.opener.location.origin;
            }
          } catch (e) {
            // COOP blocks cross-origin access
          }

          // Default to same origin (assuming callback is same-origin as app)
          return window.location.origin;
        }

        /**
         * Posts a message to the opener window
         */
        function postToOpener(message) {
          var targetOrigin = getTargetOrigin();
          
          if (window.opener) {
            try {
              window.opener.postMessage(message, targetOrigin);
              return true;
            } catch (e) {
              console.error('Failed to post message to opener:', e);
            }
          }
          return false;
        }

        /**
         * Extracts credentials from the URL hash (Firebase returns tokens in hash)
         */
        function extractCredentialsFromHash() {
          var hash = window.location.hash.substring(1);
          if (!hash) return null;

          var params = {};
          hash.split('&').forEach(function(pair) {
            var parts = pair.split('=');
            if (parts.length === 2) {
              params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1]);
            }
          });

          // Firebase may return access_token and/or id_token
          if (params.access_token || params.id_token) {
            return {
              accessToken: params.access_token || null,
              idToken: params.id_token || null
            };
          }

          return null;
        }

        /**
         * Extracts error information from URL parameters
         */
        function extractErrorFromUrl() {
          var urlParams = new URLSearchParams(window.location.search);
          var hashParams = new URLSearchParams(window.location.hash.substring(1));
          
          // Check both query params and hash for error
          var error = urlParams.get('error') || hashParams.get('error');
          var errorDescription = urlParams.get('error_description') || 
                                  hashParams.get('error_description');
          
          if (error) {
            return {
              error: error,
              errorDescription: errorDescription || 'Authentication failed'
            };
          }
          
          return null;
        }

        /**
         * Handle the Firebase auth callback response
         * Firebase's widget may include data in __authCb parameter
         */
        function extractFirebaseCallback() {
          var urlParams = new URLSearchParams(window.location.search);
          var authCb = urlParams.get('__authCb');
          
          if (authCb) {
            try {
              var data = JSON.parse(decodeURIComponent(authCb));
              if (data.idToken || data.accessToken) {
                return {
                  idToken: data.idToken || null,
                  accessToken: data.accessToken || null
                };
              }
              if (data.error) {
                return {
                  error: data.error.message || 'Authentication failed',
                  errorCode: data.error.code || 'auth/popup-error'
                };
              }
            } catch (e) {
              console.error('Failed to parse auth callback:', e);
            }
          }
          
          return null;
        }

        /**
         * Main callback handler
         */
        function handleCallback() {
          // Check for errors first
          var errorInfo = extractErrorFromUrl();
          if (errorInfo) {
            showError(errorInfo.errorDescription);
            postToOpener({
              type: 'auth-error',
              payload: {
                error: errorInfo.errorDescription,
                errorCode: errorInfo.error
              }
            });
            return;
          }

          // Try to extract credentials from Firebase callback format
          var firebaseCredentials = extractFirebaseCallback();
          if (firebaseCredentials) {
            if (firebaseCredentials.error) {
              showError(firebaseCredentials.error);
              postToOpener({
                type: 'auth-error',
                payload: {
                  error: firebaseCredentials.error,
                  errorCode: firebaseCredentials.errorCode
                }
              });
              return;
            }
            
            messageEl.textContent = 'Sign-in successful! Closing...';
            postToOpener({
              type: 'auth-success',
              payload: {
                idToken: firebaseCredentials.idToken,
                accessToken: firebaseCredentials.accessToken
              }
            });
            
            // Close popup after short delay
            setTimeout(function() {
              window.close();
            }, 500);
            return;
          }

          // Try to extract credentials from URL hash (standard OAuth)
          var credentials = extractCredentialsFromHash();
          if (credentials) {
            messageEl.textContent = 'Sign-in successful! Closing...';
            postToOpener({
              type: 'auth-success',
              payload: credentials
            });
            
            // Close popup after short delay
            setTimeout(function() {
              window.close();
            }, 500);
            return;
          }

          // No credentials found - might be initial load or error
          // Wait a moment in case page is still loading
          messageEl.textContent = 'Processing authentication...';
          
          // Set a timeout to handle case where auth fails silently
          setTimeout(function() {
            // Check again for credentials
            var retryCredentials = extractCredentialsFromHash() || extractFirebaseCallback();
            if (retryCredentials && !retryCredentials.error) {
              messageEl.textContent = 'Sign-in successful! Closing...';
              postToOpener({
                type: 'auth-success',
                payload: retryCredentials
              });
              setTimeout(function() { window.close(); }, 500);
            } else {
              // Still no credentials after waiting - user may need to complete OAuth
              messageEl.textContent = 'Waiting for authentication...';
            }
          }, 1000);
        }

        /**
         * Set up beforeunload handler to notify opener when closing
         */
        function setupCloseHandler() {
          window.addEventListener('beforeunload', function() {
            postToOpener({
              type: 'popup-closing'
            });
          });

          // Also handle pagehide for mobile browsers
          window.addEventListener('pagehide', function() {
            postToOpener({
              type: 'popup-closing'
            });
          });
        }

        // Initialize
        setupCloseHandler();
        
        // Handle callback on load
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', handleCallback);
        } else {
          handleCallback();
        }

        // Also handle hash changes (in case OAuth redirects with hash)
        window.addEventListener('hashchange', function() {
          handleCallback();
        });
      })();
    </script>
  </body>
</html>
