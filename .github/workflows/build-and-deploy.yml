name: Build and Push Container Image

on:
  push:
    branches: [main]
    paths:
      - 'server/**'
      - 'src/**'
      - 'components/**'
      - 'Dockerfile'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'tsconfig.json'
      - '.github/workflows/build-and-deploy.yml'
  pull_request:
    branches: [main]
    paths:
      - 'server/**'
      - 'src/**'
      - 'components/**'
      - 'Dockerfile'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'tsconfig.json'
      - '.github/workflows/build-and-deploy.yml'
  workflow_dispatch:

env:
  GCP_PROJECT_ID: gen-lang-client-0615287333
  GCP_REGION: us-west1
  ARTIFACT_REGISTRY: vehicle-in-need
  SERVICE_NAME: pre-order-dealer-exchange-tracker
  IMAGE_NAME: us-west1-docker.pkg.dev/gen-lang-client-0615287333/vehicle-in-need/pre-order-dealer-exchange-tracker

permissions:
  contents: read
  id-token: write  # Required for Workload Identity Federation

jobs:
  build-and-push:
    name: Build and Push Container Image
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Note: Workload Identity Federation setup required
      # Alternatively, use service account key authentication (store JSON key in GitHub Secrets as GCP_SA_KEY)
      # For now, this is a placeholder - actual GCP authentication needs to be configured
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          # Option 1: Workload Identity Federation (recommended)
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          
          # Option 2: Service Account Key (if WIF not configured, uncomment below)
          # credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Extract metadata for Docker
        id: meta
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "build_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          # Note: Using DOCKER_BUILDKIT=0 to avoid npm "Exit handler never called!" bug
          # This is a known issue with npm in Docker BuildKit environments
          DOCKER_BUILDKIT=0 docker build \
            --platform=linux/amd64 \
            --build-arg COMMIT_SHA=${{ steps.meta.outputs.sha_short }} \
            --build-arg BUILD_TIME=${{ steps.meta.outputs.build_time }} \
            -t ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.sha_short }} \
            -t ${{ env.IMAGE_NAME }}:latest \
            .

      - name: Inspect image (validation)
        run: |
          echo "=== Image Inspection ==="
          docker image inspect ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.sha_short }} | jq -r '.[0].RootFS.Layers | length' > /tmp/layer_count.txt
          LAYER_COUNT=$(cat /tmp/layer_count.txt)
          echo "Number of layers: $LAYER_COUNT"
          
          if [ "$LAYER_COUNT" -eq 0 ]; then
            echo "ERROR: Image has 0 layers - invalid OCI image structure"
            exit 1
          fi
          
          echo "✓ Image structure is valid (has $LAYER_COUNT layers)"

      - name: Test container startup
        run: |
          echo "=== Testing container startup ==="
          docker run -d --name test-container -p 8080:8080 ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.sha_short }}
          
          # Wait for container to be healthy
          echo "Waiting for container to start..."
          for i in {1..30}; do
            if docker ps | grep -q test-container; then
              sleep 2
              if curl -f http://localhost:8080/health >/dev/null 2>&1; then
                echo "✓ Container started successfully and health check passed"
                docker stop test-container
                docker rm test-container
                exit 0
              fi
            fi
            sleep 1
          done
          
          echo "ERROR: Container failed to start or health check failed"
          docker logs test-container
          docker stop test-container || true
          docker rm test-container || true
          exit 1

      - name: Push image to Artifact Registry
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "=== Pushing image to Artifact Registry ==="
          docker push ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.sha_short }}
          docker push ${{ env.IMAGE_NAME }}:latest
          
          echo "✓ Image pushed successfully"
          echo "Image tags:"
          echo "  - ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.sha_short }}"
          echo "  - ${{ env.IMAGE_NAME }}:latest"

      - name: Output deployment command
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "=== Deployment Instructions ==="
          echo ""
          echo "To deploy this image to Cloud Run, use:"
          echo ""
          echo "gcloud run deploy ${{ env.SERVICE_NAME }} \\"
          echo "  --image ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.sha_short }} \\"
          echo "  --region ${{ env.GCP_REGION }} \\"
          echo "  --platform managed \\"
          echo "  --allow-unauthenticated \\"
          echo "  --set-env-vars NODE_ENV=production,APP_VERSION=${{ steps.meta.outputs.sha_short }},BUILD_TIME=${{ steps.meta.outputs.build_time }}"
          echo ""
          echo "Or use the existing cloudbuild.yaml:"
          echo "gcloud builds submit --config cloudbuild.yaml"

      - name: Summary
        if: always()
        run: |
          echo "### Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: ${{ steps.meta.outputs.sha_short }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: ${{ steps.meta.outputs.build_time }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.sha_short }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **Image pushed to Artifact Registry**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ℹ️ **Image built but not pushed** (not a push to main)" >> $GITHUB_STEP_SUMMARY
          fi
