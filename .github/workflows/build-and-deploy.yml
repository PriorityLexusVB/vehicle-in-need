name: Build and Push Container (Cloud Build)

# This workflow builds and pushes the container image to Artifact Registry
# using Google Cloud Build, which produces valid OCI images.
#
# The previous deployment failure was caused by an invalid OCI image with
# mismatched manifest layers and config diff_ids. This workflow ensures
# proper image structure by using Cloud Build's standard Docker builder.

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'server/**'
      - 'components/**'
      - 'services/**'
      - 'Dockerfile'
      - 'cloudbuild.yaml'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/build-and-deploy.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'server/**'
      - 'components/**'
      - 'services/**'
      - 'Dockerfile'
      - 'cloudbuild.yaml'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/build-and-deploy.yml'
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to Cloud Run after build'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write # Required for Workload Identity Federation

env:
  GCP_PROJECT_ID: gen-lang-client-0615287333
  GCP_REGION: us-west1
  ARTIFACT_REGISTRY: vehicle-in-need
  SERVICE_NAME: pre-order-dealer-exchange-tracker

jobs:
  validate:
    name: Validate Build Configuration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Dockerfile
        run: |
          if [ ! -f Dockerfile ]; then
            echo "❌ Dockerfile not found"
            exit 1
          fi
          echo "✅ Dockerfile found"
          
      - name: Validate cloudbuild.yaml
        run: |
          if [ ! -f cloudbuild.yaml ]; then
            echo "❌ cloudbuild.yaml not found"
            exit 1
          fi
          echo "✅ cloudbuild.yaml found"
          
      - name: Check for conflict markers
        run: |
          if grep -r '<<<<<<< \|=======$\|>>>>>>> ' --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules .; then
            echo "❌ Git merge conflict markers found in source code!"
            exit 1
          fi
          echo "✅ No conflict markers detected"

  build:
    name: Build Container Image
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate GCP auth inputs
        id: validate-gcp-auth
        shell: bash
        run: |
          set -euo pipefail
          PROVIDER="${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}"
          SA="${{ secrets.GCP_SERVICE_ACCOUNT }}"
          echo "Validating GCP auth inputs..."
          if [ -z "$PROVIDER" ]; then
            echo "::error::Missing repository secret: GCP_WORKLOAD_IDENTITY_PROVIDER"
            exit 1
          fi
          if ! echo "$PROVIDER" | grep -qE '^projects/[0-9]+/locations/global/workloadIdentityPools/[^/]+/providers/[^/]+$'; then
            echo "::error::GCP_WORKLOAD_IDENTITY_PROVIDER has invalid format. Expected: projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL/providers/PROVIDER"
            exit 1
          fi
          if [ -z "$SA" ]; then
            echo "::error::Missing repository secret: GCP_SERVICE_ACCOUNT"
            exit 1
          fi
          if ! echo "$SA" | grep -qE '^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.iam\.gserviceaccount\.com$'; then
            echo "::error::GCP_SERVICE_ACCOUNT has invalid format. Expected: SERVICE_ACCOUNT@PROJECT_ID.iam.gserviceaccount.com"
            exit 1
          fi
          echo "✅ GCP auth inputs validated successfully"
      
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev
          
      - name: Submit build to Cloud Build
        id: build
        run: |
          # Use the full GitHub SHA for the build, converted to short form
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "Using SHORT_SHA: $SHORT_SHA (from commit: ${{ github.sha }})"
          
          BUILD_ID=$(gcloud builds submit \
            --config cloudbuild.yaml \
            --substitutions=SHORT_SHA=$SHORT_SHA,_REGION=${{ env.GCP_REGION }},_SERVICE=${{ env.SERVICE_NAME }} \
            --format='value(id)')
          
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "✅ Cloud Build submitted: $BUILD_ID"
          
      - name: Wait for build completion
        run: |
          echo "Waiting for build ${{ steps.build.outputs.build_id }} to complete..."
          gcloud builds log ${{ steps.build.outputs.build_id }} --stream
          
      - name: Verify build status
        run: |
          STATUS=$(gcloud builds describe ${{ steps.build.outputs.build_id }} --format='value(status)')
          if [ "$STATUS" != "SUCCESS" ]; then
            echo "❌ Build failed with status: $STATUS"
            exit 1
          fi
          echo "✅ Build succeeded"
          
      - name: Verify image in Artifact Registry
        run: |
          IMAGE_PATH="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/${{ env.SERVICE_NAME }}"
          SHORT_SHA="${{ steps.build.outputs.short_sha }}"
          
          echo "Checking for image at: $IMAGE_PATH"
          if gcloud artifacts docker images list $IMAGE_PATH --limit=1 | grep -q "$SHORT_SHA"; then
            echo "✅ Image found in Artifact Registry with tag: $SHORT_SHA"
          else
            echo "❌ Image not found in Artifact Registry"
            exit 1
          fi
          
      - name: Inspect image structure (validation)
        run: |
          SHORT_SHA="${{ steps.build.outputs.short_sha }}"
          IMAGE_PATH="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/${{ env.SERVICE_NAME }}:$SHORT_SHA"
          
          echo "Pulling image for inspection..."
          docker pull $IMAGE_PATH
          
          echo "Inspecting image structure..."
          docker inspect $IMAGE_PATH > /tmp/image-inspect.json
          
          LAYERS=$(jq -r '.[0].RootFS.Layers | length' /tmp/image-inspect.json)
          echo "Number of layers: $LAYERS"
          
          if [ "$LAYERS" -gt 0 ]; then
            echo "✅ Image has valid layer structure ($LAYERS layers)"
          else
            echo "❌ Image has no layers - this indicates a structural problem"
            exit 1
          fi
          
      - name: Generate deployment command
        run: |
          SHORT_SHA="${{ steps.build.outputs.short_sha }}"
          
          echo "### Deployment Command" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "gcloud run deploy ${{ env.SERVICE_NAME }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/${{ env.SERVICE_NAME }}:$SHORT_SHA \\" >> $GITHUB_STEP_SUMMARY
          echo "  --region=${{ env.GCP_REGION }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  --platform=managed \\" >> $GITHUB_STEP_SUMMARY
          echo "  --allow-unauthenticated \\" >> $GITHUB_STEP_SUMMARY
          echo "  --set-env-vars=NODE_ENV=production,APP_VERSION=$SHORT_SHA,BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "### Deployed Version" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Short SHA**: $SHORT_SHA" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  # Manual deployment gate - only runs on workflow_dispatch with deploy=true
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true'
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate GCP auth inputs
        id: validate-gcp-auth
        shell: bash
        run: |
          set -euo pipefail
          PROVIDER="${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}"
          SA="${{ secrets.GCP_SERVICE_ACCOUNT }}"
          echo "Validating GCP auth inputs..."
          if [ -z "$PROVIDER" ]; then
            echo "::error::Missing repository secret: GCP_WORKLOAD_IDENTITY_PROVIDER"
            exit 1
          fi
          if ! echo "$PROVIDER" | grep -qE '^projects/[0-9]+/locations/global/workloadIdentityPools/[^/]+/providers/[^/]+$'; then
            echo "::error::GCP_WORKLOAD_IDENTITY_PROVIDER has invalid format. Expected: projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL/providers/PROVIDER"
            exit 1
          fi
          if [ -z "$SA" ]; then
            echo "::error::Missing repository secret: GCP_SERVICE_ACCOUNT"
            exit 1
          fi
          if ! echo "$SA" | grep -qE '^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.iam\.gserviceaccount\.com$'; then
            echo "::error::GCP_SERVICE_ACCOUNT has invalid format. Expected: SERVICE_ACCOUNT@PROJECT_ID.iam.gserviceaccount.com"
            exit 1
          fi
          echo "✅ GCP auth inputs validated successfully"
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        
      - name: Deploy to Cloud Run
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/${{ env.SERVICE_NAME }}:$SHORT_SHA \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars=NODE_ENV=production,APP_VERSION=$SHORT_SHA,BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            
      - name: Verify deployment
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          
          echo "Service deployed at: $SERVICE_URL"
          
          # Health check
          if curl -f "$SERVICE_URL/health"; then
            echo "✅ Health check passed"
          else
            echo "❌ Health check failed"
            exit 1
          fi
          
          # Status check
          VERSION=$(curl -s "$SERVICE_URL/api/status" | jq -r '.version')
          echo "Deployed version: $VERSION"
          
          if [ "$VERSION" = "$SHORT_SHA" ]; then
            echo "✅ Version matches deployment"
          else
            echo "⚠️  Version mismatch - deployed: $VERSION, expected: $SHORT_SHA"
          fi
