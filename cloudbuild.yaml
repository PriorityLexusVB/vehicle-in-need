# Build and deploy container image to Cloud Run via Artifact Registry (us-west1)
#
# Cloud Build Substitution Variables:
#   - Custom substitutions MUST start with underscore (_) per Cloud Build requirements
#   - Built-in substitutions (PROJECT_ID, SHORT_SHA, BUILD_ID) are provided automatically
#
# Trigger:
#   - Trigger name: vehicle-in-need-deploy
#   - filename: cloudbuild.yaml
#   - substitutions:
#       _REGION: us-west1
#       _SERVICE: pre-order-dealer-exchange-tracker

substitutions:
  # Custom substitutions (must start with underscore):
  _REGION: us-west1
  _SERVICE: pre-order-dealer-exchange-tracker
  # Built-ins used (no need to define):
  #   PROJECT_ID  ‚Äì GCP project ID
  #   SHORT_SHA   ‚Äì short commit SHA (7 chars)
  #   BUILD_ID    ‚Äì unique build ID

steps:
  # Guard: Fail fast if merge conflict markers are present
  - name: gcr.io/cloud-builders/gcloud
    id: check-conflicts
    entrypoint: bash
    args:
      - -c
      - |
        if grep -r '<<<<<<< \|=======$\|>>>>>>> ' \
          --include="*.ts" --include="*.tsx" \
          --include="*.js" --include="*.jsx" \
          --include="*.html" --exclude-dir=node_modules .; then
          echo "ERROR: Git merge conflict markers found in source code!"
          exit 1
        fi
        echo "‚úì No conflict markers detected"

  # Guard: Validate SHORT_SHA looks like a commit SHA
  - name: gcr.io/cloud-builders/gcloud
    id: validate-version
    waitFor: ['check-conflicts']
    entrypoint: bash
    args:
      - -c
      - |
        echo "üîç Validating deployment version..."
        echo "SHORT_SHA: ${SHORT_SHA}"

        # Do NOT allow 'manual...' style versions in this pipeline
        if [[ "${SHORT_SHA}" =~ ^manual ]]; then
          echo "‚ùå ERROR: Manual deployment versions are not allowed in this pipeline."
          echo "   SHORT_SHA: ${SHORT_SHA}"
          echo ""
          echo "Use a real commit SHA instead:"
          echo "  SHORT_SHA=\$(git rev-parse --short HEAD)"
          echo "  gcloud builds submit --config=cloudbuild.yaml \\"
          echo "    --substitutions=_REGION=us-west1,_SERVICE=${_SERVICE},SHORT_SHA=\$SHORT_SHA"
          exit 1
        fi

        # Validate format is typical git SHA (7‚Äì40 hex chars)
        if ! [[ "${SHORT_SHA}" =~ ^[a-fA-F0-9]{7,40}$ ]]; then
          echo "‚ö†Ô∏è WARNING: SHORT_SHA does not match standard git commit format"
          echo "   SHORT_SHA: ${SHORT_SHA}"
          echo "   Expected: 7‚Äì40 character hexadecimal string"
          echo "   Continuing anyway..."
        fi

        echo "‚úÖ Version validation passed: ${SHORT_SHA}"

  # Build the Docker image using your Dockerfile
  - name: gcr.io/cloud-builders/docker
    id: build-image
    waitFor: ['validate-version']
    args:
      - build
      - --build-arg
      - COMMIT_SHA=${SHORT_SHA}
      - --build-arg
      - BUILD_TIME=${BUILD_ID}
      - -t
      - us-west1-docker.pkg.dev/${PROJECT_ID}/vehicle-in-need/${_SERVICE}:${SHORT_SHA}
      - -t
      - us-west1-docker.pkg.dev/${PROJECT_ID}/vehicle-in-need/${_SERVICE}:latest
      - .

  # Push versioned image
  - name: gcr.io/cloud-builders/docker
    id: push-image
    waitFor: ['build-image']
    args:
      - push
      - us-west1-docker.pkg.dev/${PROJECT_ID}/vehicle-in-need/${_SERVICE}:${SHORT_SHA}

  # Push latest tag
  - name: gcr.io/cloud-builders/docker
    id: push-latest
    waitFor: ['build-image']
    args:
      - push
      - us-west1-docker.pkg.dev/${PROJECT_ID}/vehicle-in-need/${_SERVICE}:latest

  # Deploy to Cloud Run
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: deploy-cloud-run
    entrypoint: gcloud
    waitFor: ['push-image']
    args:
      - run
      - deploy
      - ${_SERVICE}
      - --image=us-west1-docker.pkg.dev/${PROJECT_ID}/vehicle-in-need/${_SERVICE}:${SHORT_SHA}
      - --region=${_REGION}
      - --platform=managed
      - --allow-unauthenticated
      - --service-account=pre-order-dealer-exchange-860@gen-lang-client-0615287333.iam.gserviceaccount.com
      - --set-env-vars=NODE_ENV=production,APP_VERSION=${SHORT_SHA},BUILD_TIME=${BUILD_ID}
      - --update-secrets=API_KEY=vehicle-in-need-gemini:latest

images:
  - us-west1-docker.pkg.dev/${PROJECT_ID}/vehicle-in-need/${_SERVICE}:${SHORT_SHA}
  - us-west1-docker.pkg.dev/${PROJECT_ID}/vehicle-in-need/${_SERVICE}:latest

timeout: 1200s
options:
  machineType: 'N1_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
