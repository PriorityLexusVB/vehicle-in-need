rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /****************************************
     * Helper Functions
     ****************************************/
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isManager() {
      // Manager status is determined by custom claims only to avoid circular dependencies.
      // This function is kept for potential future use but is currently unused in the rules.
      // All manager checks are inlined to use custom claims directly.
      return isSignedIn() 
        && ('isManager' in request.auth.token) 
        && request.auth.token.isManager == true;
    }

    function isBool(v) {
      return v is bool;
    }

    /****************************************
     * Users Collection
     ****************************************/
    match /users/{userId} {

      // CREATE:
      // User can create their own profile but cannot assign themselves manager.
      // We enforce allowed keys and ensure isManager is false (or omitted).
      allow create: if isOwner(userId)
        && (
          // Either isManager is omitted OR explicitly false
          !('isManager' in request.resource.data)
          || request.resource.data.isManager == false
        )
        // Allowed keys - only displayName, email, and isManager permitted
        // Use difference check: incoming keys must be subset of allowed keys
        && request.resource.data.keys().hasAll(['displayName', 'email'])
        && request.resource.data.keys().hasOnly(['displayName', 'email', 'isManager'])
        // Email must match auth token (ensures integrity)
        && request.resource.data.email == request.auth.token.email
        // If provided, isManager must be boolean
        && (!('isManager' in request.resource.data) || isBool(request.resource.data.isManager));

      // READ: User can read self; managers (with custom claims only) can read anyone.
      // IMPORTANT: Manager read via Firestore document check is NOT supported here because
      // it would create infinite recursion when get(/users/{uid}) is called from other rules.
      // Managers MUST use custom claims for reading other users' documents.
      allow read: if isOwner(userId)
        || (isSignedIn() && ('isManager' in request.auth.token) && request.auth.token.isManager == true);

      // UPDATE:
      // - Manager can update other users (including changing isManager).
      // - User updating self cannot change isManager.
      // - Email is immutable; restrict key set to existing keys to avoid schema drift.
      // NOTE: Manager check uses custom claims only to avoid reading the user doc during update.
      allow update: if (
          ((isSignedIn() && ('isManager' in request.auth.token) && request.auth.token.isManager == true) && !isOwner(userId))  // Manager editing another user
          ||
          (
            isOwner(userId) 
            && (
              // isManager not in update, or it matches existing value
              !('isManager' in request.resource.data)
              || (
                ('isManager' in resource.data) 
                && ('isManager' in request.resource.data)
                && request.resource.data.isManager == resource.data.isManager
              )
            )
          ) // Self without role change
        )
        // Keep email immutable
        && request.resource.data.email == resource.data.email
        // Prevent adding arbitrary new keys (exact same set as before)
        && request.resource.data.keys().hasOnly(resource.data.keys())
        // Role must stay a boolean if present
        && (!('isManager' in resource.data) || isBool(resource.data.isManager));

      // DELETE: Blocked from client.
      allow delete: if false;
    }

    /****************************************
     * Orders Collection
     ****************************************/
    match /orders/{orderId} {

      // Helper: current order owner
      function isOrderOwner() {
        return isSignedIn() 
          && resource != null 
          && ('createdByUid' in resource.data) 
          && resource.data.createdByUid == request.auth.uid;
      }

      // CREATE:
      // Authenticated user can create an order but must set ownership fields correctly.
      // Enforce required fields and simple schema constraints.
      allow create: if isSignedIn()
        && request.resource.data.keys().hasAll(['createdByUid', 'createdByEmail', 'createdAt'])
        // Ownership integrity
        && request.resource.data.createdByUid == request.auth.uid
        && request.resource.data.createdByEmail == request.auth.token.email
        // Basic status constraint (adjust as needed)
        && request.resource.data.status in ['Factory Order', 'Locate', 'Dealer Exchange', 'Received', 'Delivered'];

      // READ:
      // Owners can read their own orders.
      // Managers (with custom claims) can read any order.
      allow read: if isOrderOwner();
      allow read: if isSignedIn() && ('isManager' in request.auth.token) && request.auth.token.isManager == true;

      // UPDATE:
      // - Managers (with custom claims) can update any order.
      // - Owners can update limited mutable fields (e.g. status, notes) without changing ownership.
      allow update: if isSignedIn() && ('isManager' in request.auth.token) && request.auth.token.isManager == true;
      allow update: if isOrderOwner()
        // Ownership must remain unchanged
        && ('createdByUid' in request.resource.data)
        && request.resource.data.createdByUid == resource.data.createdByUid
        && ('createdByEmail' in request.resource.data)
        && request.resource.data.createdByEmail == resource.data.createdByEmail
        // Restrict which keys owner may touch (cannot add/remove ownership fields or other protected fields)
        && request.resource.data.keys().hasOnly(resource.data.keys())
        // Optional: owners can only change these fields
        && request.resource.data.status in ['Factory Order', 'Locate', 'Dealer Exchange', 'Received', 'Delivered'];

      // DELETE: Managers (with custom claims) only.
      allow delete: if isSignedIn() && ('isManager' in request.auth.token) && request.auth.token.isManager == true;
    }

    /****************************************
     * Vehicle Options Collection
     ****************************************/
    match /vehicleOptions/{optionId} {
      // READ: All authenticated users can read vehicle options
      allow read: if isSignedIn();

      // CREATE/UPDATE/DELETE: Managers only
      allow create, update, delete: if isSignedIn() && ('isManager' in request.auth.token) && request.auth.token.isManager == true;
    }
  }
}
