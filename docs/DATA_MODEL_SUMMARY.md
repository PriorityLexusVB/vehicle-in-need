# Data Model Summary for Orders/Deals

This document provides a comprehensive overview of the data model used for storing and managing vehicle orders (deals) in Firebase Firestore. This guide is intended for bulk addition or update operations for orders not yet secured.

## Firestore Collection Structure

### Orders Collection

**Collection Name:** `orders`

**Collection Path:** `/orders/{orderId}`

The `orders` collection stores all vehicle orders/deals in the system. Each document in this collection represents a single customer order.

---

## Order Document Schema

### TypeScript Interface

```typescript
interface Order {
  // Document ID (auto-generated by Firestore)
  id: string;
  
  // Staff Information
  salesperson: string;         // Required - Name of the salesperson
  manager: string;             // Required - Name of the manager
  
  // Date & Customer Information
  date: string;                // Required - Date in ISO format (YYYY-MM-DD)
  customerName: string;        // Required - Customer's full name (e.g., "DAMUTH", "ALICE JOHNSON")
  
  // Deal Identifiers
  stockNumber?: string;        // Optional - Stock number
  dealNumber: string;          // Required - Unique deal number
  vin?: string;                // Optional - Last 8 characters of VIN
  
  // Vehicle Specification
  year: string;                // Required - Model year (e.g., "2025", "2024", "2023")
  model: string;               // Required - Vehicle model name
  modelNumber: string;         // Required - 4-character model code (e.g., "350H")
  
  // Color Options (use color codes, not names)
  exteriorColor1: string;      // Required - Primary exterior color code (min 3 chars, e.g., "01UL")
  exteriorColor2?: string;     // Optional - Secondary exterior color code
  exteriorColor3?: string;     // Optional - Tertiary exterior color code
  interiorColor1: string;      // Required - Primary interior color code (e.g., "LA40")
  interiorColor2?: string;     // Optional - Secondary interior color code
  interiorColor3?: string;     // Optional - Tertiary interior color code
  
  // Financial Information
  msrp: number;                // Required - Manufacturer's suggested retail price
  sellingPrice?: number;       // Optional - Actual selling price
  gross?: number;              // Optional - Gross profit
  depositAmount: number;       // Required - Customer deposit amount
  
  // Status & Notes
  status: OrderStatus;         // Required - Current order status (see Status Values below)
  options: string;             // Required - Key packages and accessories description
  notes?: string;              // Optional - Internal notes
  
  // Ownership & Audit Fields (automatically set by the application)
  createdAt?: Timestamp;       // Firestore server timestamp - when order was created
  createdByUid?: string;       // UID of user who created the order
  createdByEmail?: string;     // Email of user who created the order
}
```

---

## Status Values (OrderStatus Enum)

```typescript
enum OrderStatus {
  FactoryOrder = 'Factory Order',    // Initial status - order placed with factory
  Locate = 'Locate',                 // Vehicle is being located
  DealerExchange = 'Dealer Exchange', // Vehicle coming from dealer exchange
  Received = 'Received',             // Vehicle received (legacy - maps to Secured)
  Delivered = 'Delivered',           // Vehicle delivered to customer (legacy - maps to Secured)
  Secured = 'Secured',               // UI-only status for display purposes
}
```

### Status Classification

**Active Statuses** (orders not yet secured):
- `Factory Order`
- `Locate`
- `Dealer Exchange`

**Secured Statuses** (completed orders):
- `Received` (legacy)
- `Delivered` (legacy)
- `Secured` (UI display only, stored as `Delivered` in database)

---

## Sample Order Documents

### Example 1: DAMUTH (Factory Order)

```json
{
  "salesperson": "John Smith",
  "manager": "Rob Brasco",
  "date": "2024-11-15",
  "customerName": "DAMUTH",
  "dealNumber": "D2024-001",
  "stockNumber": "STK12345",
  "vin": "ABC12345",
  "year": "2025",
  "model": "Lexus ES 350",
  "modelNumber": "350H",
  "exteriorColor1": "01UL",
  "exteriorColor2": "",
  "exteriorColor3": "",
  "interiorColor1": "LA40",
  "interiorColor2": "",
  "interiorColor3": "",
  "msrp": 45000.00,
  "sellingPrice": 43500.00,
  "gross": 2500.00,
  "depositAmount": 1000.00,
  "status": "Factory Order",
  "options": "Premium Package, Navigation, Heated Seats",
  "notes": "Customer prefers delivery on weekends",
  "createdAt": "<Firestore Server Timestamp>",
  "createdByUid": "abc123xyz",
  "createdByEmail": "john.smith@priorityautomotive.com"
}
```

### Example 2: ALICE JOHNSON (Dealer Exchange)

```json
{
  "salesperson": "Jane Doe",
  "manager": "Rob Brasco",
  "date": "2024-11-20",
  "customerName": "ALICE JOHNSON",
  "dealNumber": "D2024-002",
  "stockNumber": "STK67890",
  "vin": "XYZ98765",
  "year": "2024",
  "model": "Lexus RX 350h",
  "modelNumber": "350h",
  "exteriorColor1": "02BL",
  "interiorColor1": "LA20",
  "msrp": 52000.00,
  "sellingPrice": 51000.00,
  "depositAmount": 2000.00,
  "status": "Dealer Exchange",
  "options": "F Sport Package, Mark Levinson Audio",
  "createdAt": "<Firestore Server Timestamp>",
  "createdByUid": "def456uvw",
  "createdByEmail": "jane.doe@priorityautomotive.com"
}
```

---

## Data Fetching Logic

### How the Dashboard Fetches Orders

The application uses Firebase Firestore real-time listeners to fetch and display orders:

```typescript
// For managers - fetch ALL orders
const allOrdersQuery = query(
  collection(db, "orders"),
  orderBy("createdAt", "desc")
);

// For non-managers - fetch only their own orders
const userOwnOrdersQuery = query(
  collection(db, "orders"),
  where("createdByUid", "==", user.uid),
  orderBy("createdAt", "desc")
);
```

### Display Logic

1. **Active Orders Tab**: Shows orders with status `Factory Order`, `Locate`, or `Dealer Exchange`
2. **Secured History Tab**: Shows orders with status `Received`, `Delivered`, or `Secured`

---

## Firestore Security Rules Summary

### Create Operations

Any authenticated user can create an order, but must:
1. Include required ownership fields: `createdByUid`, `createdByEmail`, `createdAt`
2. Set `createdByUid` to their own UID
3. Set `createdByEmail` to their own email (from auth token)
4. Use a valid status value

### Read Operations

- Order owners can read their own orders
- Managers can read all orders

### Update Operations

- Managers can update any order
- Owners can update limited fields on their own orders (status must remain valid, ownership fields immutable)

### Delete Operations

- Only managers can delete orders

---

## Bulk Operations Guidelines

### For Adding New Orders (Not Yet Secured)

When bulk adding orders programmatically:

1. **Required Fields**:
   - `salesperson`, `manager`, `date`, `customerName`, `dealNumber`
   - `year`, `model`, `modelNumber`
   - `exteriorColor1`, `interiorColor1`
   - `msrp`, `depositAmount`
   - `status`, `options`
   - `createdByUid`, `createdByEmail`, `createdAt` (ownership fields)

2. **Valid Status Values** for new orders:
   - `'Factory Order'` (default)
   - `'Locate'`
   - `'Dealer Exchange'`

3. **Server Timestamp**:
   Use `serverTimestamp()` from Firebase for `createdAt`:
   ```typescript
   import { serverTimestamp } from "firebase/firestore";
   
   const newOrder = {
     // ... other fields
     createdAt: serverTimestamp(),
   };
   ```

4. **Ownership Fields**:
   Must match the authenticated user performing the bulk operation:
   ```typescript
   createdByUid: auth.currentUser.uid,
   createdByEmail: auth.currentUser.email,
   ```

### For Updating Existing Orders

When bulk updating orders:

1. **Managers**: Can update any field except ownership fields
2. **Non-managers**: Can only update their own orders, limited to allowed fields
3. **Status transitions**: Use `'Delivered'` when marking orders as secured (not `'Secured'`)

### Example Bulk Add Script Pattern

```typescript
import { collection, addDoc, serverTimestamp } from "firebase/firestore";
import { db, auth } from "./services/firebase";

const bulkAddOrders = async (ordersData: Omit<Order, 'id' | 'createdAt' | 'createdByUid' | 'createdByEmail'>[]) => {
  const user = auth.currentUser;
  if (!user || !user.email) {
    throw new Error("User must be authenticated");
  }

  for (const orderData of ordersData) {
    const completeOrder = {
      ...orderData,
      createdAt: serverTimestamp(),
      createdByUid: user.uid,
      createdByEmail: user.email,
    };
    
    await addDoc(collection(db, "orders"), completeOrder);
  }
};
```

---

## Related Collections

### Users Collection

**Collection Name:** `users`

**Collection Path:** `/users/{userId}`

Stores user profiles and role information. Relevant for determining permissions for bulk operations.

```typescript
interface AppUser {
  uid: string;
  email: string | null;
  displayName: string | null;
  isManager: boolean;
  isActive?: boolean;
  disabledAt?: Timestamp;
  disabledBy?: string;
  createdAt?: Timestamp;
  updatedAt?: Timestamp;
}
```

---

## Key Files Reference

| File | Purpose |
|------|---------|
| `types.ts` | Order and AppUser TypeScript interfaces |
| `constants.ts` | Status options, status colors, helper functions |
| `firestore.rules` | Firestore security rules |
| `App.tsx` | Main application logic, order fetching |
| `components/OrderForm.tsx` | Order creation form |
| `components/OrderList.tsx` | Order display and filtering |
| `components/OrderCard.tsx` | Individual order display |
| `services/firebase.ts` | Firebase configuration |

---

## Customer Name Conventions

Customer names in the system follow these patterns:
- **Full uppercase**: e.g., `"DAMUTH"`, `"SMITH"`
- **Title case with full name**: e.g., `"ALICE JOHNSON"`, `"Bob Williams"`

Both conventions are acceptable. The system performs case-insensitive search on customer names.

---

## Summary

- **Collection**: `orders`
- **Key customer field**: `customerName` (stores customer name like "DAMUTH", "ALICE JOHNSON")
- **Active statuses**: `Factory Order`, `Locate`, `Dealer Exchange`
- **Secured statuses**: `Received`, `Delivered` (stored as these, displayed as "Secured")
- **Required for bulk operations**: Ownership fields (`createdByUid`, `createdByEmail`, `createdAt`) must be set
- **Permissions**: Managers can read all; non-managers can only read their own orders
