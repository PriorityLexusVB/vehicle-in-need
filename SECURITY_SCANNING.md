# Container Security Scanning

This document describes the security scanning processes implemented in the CI/CD pipeline for container images.

## Overview

The build and deployment pipeline includes multiple security scanning tools to ensure container images are free from known vulnerabilities before deployment:

1. **Trivy** - Comprehensive vulnerability scanner
2. **Syft** - Software Bill of Materials (SBOM) generator
3. **Grype** - Vulnerability scanner that works with SBOMs

## Trivy Vulnerability Scanning

### What it Does

Trivy scans the container image for:
- OS package vulnerabilities (Debian, Alpine, RHEL, etc.)
- Language-specific package vulnerabilities (npm, pip, gem, etc.)
- Known CVEs in application dependencies
- Configuration issues and secrets

### Integration

Trivy runs automatically on every build in the `build-and-deploy.yml` workflow:

```yaml
- name: Run Trivy vulnerability scanner
  uses: aquasecurity/trivy-action@master
  with:
    image-ref: ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.sha_short }}
    format: 'sarif'
    output: 'trivy-results.sarif'
    severity: 'CRITICAL,HIGH'
    exit-code: '0'  # Don't fail the build, just report
```

### Results Location

- **GitHub Security Tab**: SARIF results are automatically uploaded to GitHub's Security tab
- **Workflow Logs**: Table format output is available in the workflow run logs
- **Category**: `container-security`

### Severity Levels

- **CRITICAL**: Must be addressed immediately
- **HIGH**: Should be addressed in the next release
- **MEDIUM**: Should be reviewed and addressed when practical
- **LOW**: Informational, address as time permits

## SBOM Generation with Syft

### What it Does

Syft generates a Software Bill of Materials (SBOM) in SPDX format, which includes:
- All packages and dependencies in the container
- Package versions and licenses
- Package relationships and origins
- Checksums and integrity data

### Integration

Syft runs after the Trivy scan:

```yaml
- name: Generate SBOM with Syft
  uses: anchore/sbom-action@v0
  with:
    image: ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.sha_short }}
    format: 'spdx-json'
    output-file: 'sbom.spdx.json'
```

### SBOM Access

SBOMs are uploaded as build artifacts and retained for 90 days:
- Artifact name: `sbom-<commit-sha>`
- Format: SPDX JSON
- Download from the Actions tab of the workflow run

### Use Cases

1. **Compliance**: Required for many security compliance frameworks
2. **Supply Chain Security**: Track all dependencies and their origins
3. **Vulnerability Management**: Input for additional scanning tools
4. **License Compliance**: Identify all licenses in use

## Grype Scanning

### What it Does

Grype is an additional vulnerability scanner that:
- Works directly with the SBOM generated by Syft
- Provides comprehensive vulnerability database coverage
- Offers fast scanning performance
- Cross-references multiple vulnerability databases

### Integration

Grype runs after SBOM generation:

```yaml
- name: Scan SBOM with Grype
  uses: anchore/scan-action@v4
  with:
    sbom: 'sbom.spdx.json'
    fail-build: false
    severity-cutoff: high
```

### Configuration

- **fail-build**: Set to `false` to not block builds on vulnerabilities
- **severity-cutoff**: Only report HIGH and CRITICAL vulnerabilities
- Results are displayed in the workflow logs

## Security Workflow

```
┌─────────────────┐
│  Build Image    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Test Startup   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Trivy Scan     │──► Upload to GitHub Security
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Generate SBOM  │──► Upload Artifact
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Grype Scan     │──► Log Results
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Push Image     │ (only on main branch)
└─────────────────┘
```

## Responding to Vulnerabilities

### Critical/High Severity

1. **Review** the vulnerability details in the GitHub Security tab
2. **Assess** the impact on your application
3. **Update** the affected package if a patch is available
4. **Test** the updated image thoroughly
5. **Deploy** the patched version

### Medium/Low Severity

1. **Track** the vulnerabilities in GitHub Issues
2. **Plan** updates in upcoming sprints
3. **Monitor** for severity escalations

### False Positives

If a vulnerability is a false positive:
1. Document the reason in GitHub Security
2. Dismiss the alert with justification
3. Consider adding to Trivy ignore rules if recurring

## Local Security Scanning

You can run security scans locally before pushing:

### Trivy

```bash
# Scan a local image
docker build -t myimage:test .
trivy image myimage:test

# Save results to file
trivy image -f json -o trivy-results.json myimage:test
```

### Syft

```bash
# Generate SBOM
syft myimage:test -o spdx-json > sbom.json

# View package list
syft myimage:test -o table
```

### Grype

```bash
# Scan from SBOM
grype sbom:sbom.json

# Or scan image directly
grype myimage:test
```

## Automation Benefits

1. **Early Detection**: Find vulnerabilities before production
2. **Compliance**: Automated SBOM generation for audits
3. **Visibility**: Security results in GitHub Security tab
4. **Non-Blocking**: Scans don't block deployment (can be configured)
5. **Historical Data**: SBOM artifacts provide historical dependency records

## Configuration Options

### Fail Build on Vulnerabilities

To make the build fail on critical vulnerabilities, update `.github/workflows/build-and-deploy.yml`:

```yaml
- name: Run Trivy vulnerability scanner
  uses: aquasecurity/trivy-action@master
  with:
    image-ref: ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.sha_short }}
    format: 'sarif'
    output: 'trivy-results.sarif'
    severity: 'CRITICAL,HIGH'
    exit-code: '1'  # Changed from '0' to '1' to fail build
```

### Custom Trivy Rules

Create `.trivyignore` in the repository root to ignore specific vulnerabilities:

```
# Ignore CVE-2021-12345 - false positive in development dependency
CVE-2021-12345

# Ignore until fix available
CVE-2022-67890
```

### SBOM Format Options

Syft supports multiple SBOM formats:
- `spdx-json` (current)
- `cyclonedx-json`
- `syft-json`
- `table`

## References

- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [Syft Documentation](https://github.com/anchore/syft)
- [Grype Documentation](https://github.com/anchore/grype)
- [SPDX Specification](https://spdx.dev/)
- [GitHub Security Features](https://docs.github.com/en/code-security)

## Support

For questions or issues with security scanning:
1. Check the workflow logs for detailed error messages
2. Review the GitHub Security tab for vulnerability details
3. Consult the tool documentation linked above
4. Open an issue in the repository with the `security` label
